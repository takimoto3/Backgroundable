# Backgroundable

A Swift package that simplifies background task management on Apple platforms using Swift macros.

## Overview

Backgroundable provides two Swift macros: @Backgroundable and @BackgroundableProperty.
They streamline the management of UIBackgroundTaskIdentifier for background execution in Apple applications by automating the common boilerplate code for starting and ending background tasks, reducing potential errors and improving code readability.

Using this macro, applying `@Backgroundable` to a method automatically wraps it with background task management like this:

<table>
<tr>
<th>Original Code(With Macro)</th>
<th>Generated Code</th>
</tr>
<tr valign=top>
<td width=300>

```swift
import Backgroundable
import UIKit


class MyService {
    @Backgroundable
    func sync() {
        heavyWork()
    }
}
```

</td>
<td width=750>

```swift
import UIKit

class MyService {
    func sync() {
        // - Expanded Macro -------------------
        var _backgroundTaskID: UIBackgroundTaskIdentifier = .invalid
        _backgroundTaskID = UIApplication.shared.beginBackgroundTask {
            if _backgroundTaskID != .invalid {
                UIApplication.shared.endBackgroundTask(_backgroundTaskID)
                _backgroundTaskID = .invalid
            }
        }
        defer {
            if _backgroundTaskID != .invalid {
                UIApplication.shared.endBackgroundTask(_backgroundTaskID)
                _backgroundTaskID = .invalid
            }
        }
        //  ------------------- Expanded Macro -
        heavyWork()
    }
}
```

</td>
</tr>
</table>


## Features

-   **`@Backgroundable` Macro**: Automatically injects calls to `UIApplication.shared.beginBackgroundTask(_:)` and `UIApplication.shared.endBackgroundTask(_:)` around the body of a method. It handles task naming, expiration, and ensures proper task termination.
-   **`@BackgroundableProperty` Macro**: Injects a private `UIBackgroundTaskIdentifier` property into a class. The generated property is automatically used by `@Backgroundable`  
    if no custom `propertyName` is specified.

## Installation

You can add `Backgroundable` to an Xcode project by adding it to your project as a package…

> https://github.com/takimoto3/Backgroundable.git

…and adding the `Backgroundable` product to your target.

If you want to use `Backgroundable` in a [SwiftPM](https://swift.org/package-manager/) project, it's as
simple as adding it to your `Package.swift`:

```swift
dependencies: [
  .package(url: "https://github.com/takimoto3/Backgroundable.git", from: "0.1.0")
]
```

## Usage

> [!NOTE]
> To view the code generated by a Swift macro in Xcode:
> 1. Select the macro in your code (e.g., `@Backgroundable` above a method).
> 2. Go to the menu: **Editor → Expand Macro**.
> 3. Xcode will display the expanded/generated code in place, showing exactly what the macro injects.


### 1. Using `@Backgroundable` Alone

You can apply the `@Backgroundable` macro to any method to automatically handle background task management:

```swift
import Backgroundable
import UIKit

class MyService {
    @Backgroundable
    func performDataSynchronization() {
        print("Starting data synchronization...")
        // Note: Thread.sleep is used here for demonstration purposes.
        // In production, consider using async/await or DispatchQueue for background work.
        Thread.sleep(forTimeInterval: 5) // Demo only
        print("Data synchronization finished.")
    }
}
```

<details>
<summary>Expanded Macro</summary>

```swift
    func performDataSynchronization() {
        var _backgroundTaskID: UIBackgroundTaskIdentifier = .invalid
        _backgroundTaskID = UIApplication.shared.beginBackgroundTask {
            if _backgroundTaskID != .invalid {
                UIApplication.shared.endBackgroundTask(_backgroundTaskID)
                _backgroundTaskID = .invalid
            }
        }
        defer {
            if _backgroundTaskID != .invalid {
                UIApplication.shared.endBackgroundTask(_backgroundTaskID)
                _backgroundTaskID = .invalid
            }
        }
        print("Starting data synchronization...")
        // Note: Thread.sleep is used here for demonstration purposes.
        // In production, consider using async/await or DispatchQueue for background work.
        Thread.sleep(forTimeInterval: 5) // Demo only
        print("Data synchronization finished.")
    }
}
```

</details>

##### WithName

```swift
import Backgroundable
import UIKit

class MyService {
    @Backgroundable(withName:"Slow Task")
    func performDataSynchronization() {
        print("Starting data synchronization...")
        // Note: Thread.sleep is used here for demonstration purposes.
        // In production, consider using async/await or DispatchQueue for background work.
        Thread.sleep(forTimeInterval: 5) // Demo only
        print("Data synchronization finished.")
    }
}
```
<details>
<summary>Expanded Macro</summary>

```swift
    func performDataSynchronization() {
        var _backgroundTaskID: UIBackgroundTaskIdentifier = .invalid
        _backgroundTaskID = UIApplication.shared.beginBackgroundTask(withName: "Slow Task") {
            if _backgroundTaskID != .invalid {
                UIApplication.shared.endBackgroundTask(_backgroundTaskID)
                _backgroundTaskID = .invalid
            }
        }
        defer {
            if _backgroundTaskID != .invalid {
                UIApplication.shared.endBackgroundTask(_backgroundTaskID)
                _backgroundTaskID = .invalid
            }
        }
        print("Starting data synchronization...")
        // Note: Thread.sleep is used here for demonstration purposes.
        // In production, consider using async/await or DispatchQueue for background work.
        Thread.sleep(forTimeInterval: 5) // Demo only
        print("Data synchronization finished.")
    }
}
```

</details>

##### Call Expiration Function

```swift
import Backgroundable
import UIKit

class MyService {
    @Backgroundable(expirationFunc: "cleanupTask")
    func performDataSynchronization() {
        print("Starting data synchronization...")
        // Note: Thread.sleep is used here for demonstration purposes.
        // In production, consider using async/await or DispatchQueue for background work.
        Thread.sleep(forTimeInterval: 5) // Demo only
        print("Data synchronization finished.")
    }
}
```
<details>
<summary>Expanded Macro</summary>

```swift
    func performDataSynchronization() {
        var _backgroundTaskID: UIBackgroundTaskIdentifier = .invalid
        _backgroundTaskID = UIApplication.shared.beginBackgroundTask {
            self.cleanupTask()
            if _backgroundTaskID != .invalid {
                UIApplication.shared.endBackgroundTask(_backgroundTaskID)
                _backgroundTaskID = .invalid
            }
        }
        defer {
            if _backgroundTaskID != .invalid {
                UIApplication.shared.endBackgroundTask(_backgroundTaskID)
                _backgroundTaskID = .invalid
            }
        }
        print("Starting data synchronization...")
        // Note: Thread.sleep is used here for demonstration purposes.
        // In production, consider using async/await or DispatchQueue for background work.
        Thread.sleep(forTimeInterval: 5) // Demo only
        print("Data synchronization finished.")
    }
}
```

</details>


### 2. Using `@BackgroundableProperty` (Optional)

@BackgroundableProperty can be applied only to classes.
It cannot be used on actors, and cannot be attached directly to stored properties.
This macro lets you explicitly declare the property that will store the generated UIBackgroundTaskIdentifier.
If you don’t use this macro, @Backgroundable will generate a private property for you (e.g., _backgroundTaskID).

```swift
import Backgroundable
import UIKit

@BackgroundableProperty(name: "bgTaskID")
class MyService {
    // ... rest of your class
}
```

<details>
<summary>Expanded Macro</summary>

```swift
class MyService {
   private var _bgTaskID: UIBackgroundTaskIdentifier = .invalid
    // ... rest of your class
}
```

</details>

Here's an example combining `@BackgroundableProperty` with `@Backgroundable`:

```swift
import Backgroundable
import UIKit

@BackgroundableProperty(name: "bgTaskID")
class MyService {

    @Backgroundable(propertyName: "bgTaskID")
    func processImages() {
        print("Starting data synchronization...")
        // Note: Thread.sleep is used here for demonstration purposes.
        // In production, consider using async/await or DispatchQueue for background work.
        Thread.sleep(forTimeInterval: 5) // Demo only
        print("Data synchronization finished.")
    }
    // ... rest of your class
}
```


<details>
<summary>Expanded Macro</summary>

```swift
class MyService {

    func processImages() {
        self._bgTaskID = UIApplication.shared.beginBackgroundTask {
            if self._bgTaskID != .invalid {
                UIApplication.shared.endBackgroundTask(self._bgTaskID)
                self._bgTaskID = .invalid
            }
        }
        defer {
            if self._bgTaskID != .invalid {
                UIApplication.shared.endBackgroundTask(self._bgTaskID)
                self._bgTaskID = .invalid
            }
        }
        print("Starting image processing...")
        // Note: Thread.sleep is used here for demonstration purposes.
        // In production, consider using async/await or DispatchQueue for background work.
        Thread.sleep(forTimeInterval: 10) // Demo only
        print("Image processing finished.")
    }

    // This property would be generated by @BackgroundableProperty(name: "bgTaskID")
    private var _bgTaskID: UIBackgroundTaskIdentifier = .invalid
}
```

</details>

## Macro Parameters

### `@Backgroundable` Macro Parameters

| Parameter        | Type     | Description                                                                                                                                                                                                                                                                   |
| :--------------- | :------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `propertyName`   | `String?`| The name of the stored property that holds the `UIBackgroundTaskIdentifier`. If `nil`, a local variable (`_backgroundTaskID`) is used, or the property generated by `@BackgroundableProperty` if present.                                                                   |
| `withName`       | `String?`| A human-readable name for the background task, useful for debugging in Xcode or Instruments.                                                                                                                                                                                  |
| `expirationFunc` | `String?`| The name of a `self` function to invoke when the system notifies that the task is about to expire, allowing cleanup or fallback logic.                                                                                                                                        |

### `@BackgroundableProperty` Macro Parameters

| Parameter | Type     | Description                                                                                                                                                                                                                                                                   |
| :-------- | :------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `name`    | `String?`| The name of the `UIBackgroundTaskIdentifier` property to be generated. If omitted, a default name (e.g., `_backgroundTaskID`) will be generated. The generated property will always be `private var`.                                                                           |

## Requirements

-   iOS 13+
-   tvOS 13+
-   macCatalyst 13+
-   visionOS 1.0+
-   Swift 5.9+

## Demo

This repo comes with a sample application to demonstrate the usage of `Backgroundable` macros.

* [**BackgroundableSample**](https://github.com/takimoto3/BackgroundableSample)
<br>A simple counter application using SwiftUI is available to demonstrate the `Backgroundable` macros. It showcases the before and after application of macros for `struct`, `class`, and `actor` based implementations.

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.
